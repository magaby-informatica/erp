<script>
    const PROXY_URL = 'https://script.google.com/macros/s/AKfycbzDsLi-7PNeDITvh28HvyAGESLpH_LJ8WDv0ZwG_F1PQOWdlirydZElL6deLeQwgoxB/exec';

    async function loadDrop(table, elId, col) {
        const el = document.getElementById(elId);
        try {
            const res = await fetch(PROXY_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    tableName: table, 
                    payload: { 
                        Action: 'Find', 
                        Properties: { Locale: 'es-CO' }, 
                        Rows: [] 
                    } 
                })
            });
            const data = await res.json();
            el.innerHTML = '<option value="">Seleccione...</option>';
            
            // AppSheet a veces devuelve la lista directa o dentro de un objeto "Rows"
            const rows = Array.isArray(data) ? data : (data.Rows || []);
            
            if (rows.length === 0) {
                console.warn(`No se encontraron datos en la tabla: ${table}`);
            }

            // Filtrar valores únicos y llenar el select
            [...new Set(rows.map(r => r[col]).filter(v => v))].forEach(v => {
                const o = document.createElement('option'); 
                o.value = o.textContent = v; 
                el.appendChild(o);
            });
        } catch (e) { 
            el.innerHTML = '<option value="">Error al cargar</option>';
            console.error("Error cargando " + elId + " desde tabla " + table, e);
        }
    }

    window.onload = async () => {
        document.getElementById('loading').style.display = 'flex';
        
        await Promise.all([
            // 1. Cargamos CONTRATISTAS (Tabla: CONTRATISTAS, Columna: NOMBRE)
            loadDrop('CONTRATISTAS', 'contratista', 'NOMBRE'),
            
            // 2. Cargamos ACTIVIDADES (Tabla: ACTIVIDADESDELCONTRATO, Columna: ACTIVIDAD)
            // Nota: Asegúrate que en AppSheet el nombre de la tabla sea exactamente este
            loadDrop('ACTIVIDADESDELCONTRATO', 'actividadref', 'ACTIVIDAD'),
            
            // 3. Cargamos la columna Enum (Tabla: ACTREGISTRADA, Columna: ADCTIVIDAD_REGISTRADA)
            loadDrop('ACTREGISTRADA', 'adctividad', 'ADCTIVIDAD_REGISTRADA')
        ]);
        
        document.getElementById('loading').style.display = 'none';
    };
</script>
